## Лабораторная работа №16

### Тема PostgreSQL. Имитация аномалии «Потерянное обновление»

## Отчёт
Выполнил студент гр.1, п.гр.1, Сибилев Антон Игоревич

### Цель

Продемонстрировать, как при недостаточно строгом уровне изоляции транзакций возможно возникновение аномалии "потерянное обновление". Показать влияние параллельных операций на целостность данных и изучить способы предотвращения подобных ошибок с помощью настройки уровней изоляции.

### Структура базы данных
Были созданы следующие таблицы:
* books(id, name) — список книг;
* branches(id, name) — список филиалов;
* stock(book_id, branch_id, quantity) — складской остаток книг (составной первичный ключ);
* movements(id, book_id, quantity, from_branch_id, to_branch_id, movement_time) — лог перемещений.


### Реализация
В рамках лабораторной работы проводится имитация ситуации, когда два потока одновременно пытаются переместить одну и ту же книгу из одного филиала в разные направления. При некорректной обработке такой ситуации может произойти аналогия "потерянного обновления" — когда результат одного из действий не сохраняется в БД.

Создаются таблицы, добавляются начальные данные:
* книги: Python Basics, Database Systems, Operating Systems;
* филиалы: Central Library, East Branch, West Branch;

у каждой книги по 25 экземпляров в каждом филиале.

Моделирование гонки данных
Вызвана функция simulate_race_condition(), которая запускает два параллельных потока:

* Один перемещает 5 книг из Central Library в East Branch;
* Второй перемещает 7 книг из Central Library в West Branch.

Обе операции выполняются почти одновременно, с задержкой sleep(1), чтобы возникло пересечение по времени выполнения.

### Результаты работы программы
```bash
База данных очищена.
Таблицы созданы.
Начальные данные добавлены.

Таблица stock:
+-----------+-------------+------------+
|   book_id |   branch_id |   quantity |
+===========+=============+============+
|         1 |           1 |         25 |
+-----------+-------------+------------+
|         1 |           2 |         25 |
+-----------+-------------+------------+
|         1 |           3 |         25 |
+-----------+-------------+------------+

=== Симуляция гонки данных (Isolation: READ COMMITTED) ===
[2025-06-24 22:04:50.998171] Перемещено 7 книг #1 из филиала #1 в #3
[2025-06-24 22:04:51.002871] Перемещено 5 книг #1 из филиала #1 в #2

Таблица stock:
+-----------+-------------+------------+
|   book_id |   branch_id |   quantity |
+===========+=============+============+
|         1 |           3 |         32 |
+-----------+-------------+------------+
|         1 |           1 |         13 |
+-----------+-------------+------------+
|         1 |           2 |         30 |
+-----------+-------------+------------+

Таблица movements:
+------+-----------+------------+------------------+----------------+----------------------------+
|   id |   book_id |   quantity |   from_branch_id |   to_branch_id | movement_time              |
+======+===========+============+==================+================+============================+
|    1 |         1 |          7 |                1 |              3 | 2025-06-24 19:04:49.985095 |
+------+-----------+------------+------------------+----------------+----------------------------+
|    2 |         1 |          5 |                1 |              2 | 2025-06-24 19:04:49.994248 |
+------+-----------+------------+------------------+----------------+----------------------------+

=== Симуляция гонки данных (Isolation: REPEATABLE READ) ===
[2025-06-24 22:04:52.088243] Перемещено 5 книг #1 из филиала #1 в #2
[2025-06-24 22:04:52.088778] Ошибка перемещения: could not serialize access due to concurrent update


Таблица stock:
+-----------+-------------+------------+
|   book_id |   branch_id |   quantity |
+===========+=============+============+
|         1 |           3 |         32 |
+-----------+-------------+------------+
|         1 |           1 |          8 |
+-----------+-------------+------------+
|         1 |           2 |         35 |
+-----------+-------------+------------+

Таблица movements:
+------+-----------+------------+------------------+----------------+----------------------------+
|   id |   book_id |   quantity |   from_branch_id |   to_branch_id | movement_time              |
+======+===========+============+==================+================+============================+
|    1 |         1 |          7 |                1 |              3 | 2025-06-24 19:04:49.985095 |
+------+-----------+------------+------------------+----------------+----------------------------+
|    2 |         1 |          5 |                1 |              2 | 2025-06-24 19:04:49.994248 |
+------+-----------+------------+------------------+----------------+----------------------------+
|    3 |         1 |          5 |                1 |              2 | 2025-06-24 19:04:51.075458 |
+------+-----------+------------+------------------+----------------+----------------------------+
```

### Вывод
Потерянное обновление — это ситуация, когда параллельные транзакции читают одни и те же данные и записывают новые, не видя изменений друг друга.

При низком уровне изоляции (READ COMMITTED) подобные аномалии возможны.
Более строгие уровни (REPEATABLE READ, SERIALIZABLE) помогают предотвратить подобные ошибки, но могут вызывать конфликты транзакций.

Для операций изменения остатков ресурсов в многопользовательской среде обязательно использовать блокировки (FOR UPDATE) и строгие уровни изоляции, либо подходы с проверкой версии записи.
